name: build-safe

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
      
env:
  CGR_PYTHON_BUILDER_IMAGE_NAME: "cgr.dev/cgr-demo.com/python:3.13-dev"
  CGR_PYTHON_RUNTIME_IMAGE_NAME: "cgr.dev/cgr-demo.com/python:3.13"
  # SRC: "MALWARE"
  # SRC: "CHAINGUARD"
  SRC: "PYPI_BEFORE_ATTACK"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      pull-requests: write # Required for PR comments
      issues: write # Required for issue comments

    # For PRs -> use github.head_ref (source branch)
    # For non-PR (e.g. workflow_dispatch on main) -> use github.ref (refs/heads/main)
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
        
      - name: Setup Git
        run: |
          git config --global user.email "gha@users.noreply.github.com"
          git config --global user.name "github-actions"

      - uses: octo-sts/action@6177b4481c00308b3839969c3eca88c96a91775f
        id: octo-sts
        with:
          scope: chainguard-dev/libraries-ultralytics-attack-demo
          identity: build-safe
          
      # - name: Install Cosign
      #   uses: sigstore/cosign-installer@398d4b0eeef1380460a10c8013a76f728fb906ac
      
      # - uses: chainguard-dev/setup-chainctl@272698817627c158bbd813cb783b62a4b9bbbc67
      #   with:
      #     identity: "4cf15780a13a9b6576d8b357e6524554c8c12a18/aab27dc39ad870c9"
      
      # - name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435
        
      # - name: Auth to Registry
      #   run: |
      #     chainctl auth configure-docker
      #     chainctl auth status

      # - name: Verify Chainguard Python image signatures && pre-pull images
      #   run: |
      #     CATALOG_SYNCER="4cf15780a13a9b6576d8b357e6524554c8c12a18/c03040118377d88c"
      #     APKO_BUILDER="4cf15780a13a9b6576d8b357e6524554c8c12a18/ca93125e202f81f8"
      #     cosign verify ... 
      #     docker pull ...

      # - name: Build Docker image using local base image
      #   run: |
      #     docker build \
      #       --build-arg BASE_IMAGE=${{ env.CGR_PYTHON_BUILDER_IMAGE_NAME }} \
      #       -t ultralytics:cgr-base \
      #       -f Dockerfile .
      #   working-directory: src
      
      - name: Select analysis directory and populate src/ultralytics
        id: pick-dir
        run: |
          
          rm -rf src/ultralytics/*
          mkdir -p src/ultralytics/
          if [ "${SRC}" = "CHAINGUARD" ]; then
            echo "Using directory: $SELECTED"
            rsync -av --ignore-times vendored/ultralytics-chainguard/* src/ultralytics/
          elif [ "${SRC}" = "MALWARE" ]; then
            echo "Using directory: $SELECTED"
            rsync -av --ignore-times vendored/ultralytics-before-attack/* src/ultralytics/
            rsync -av --ignore-times vendored/malcontent-samples-ultralytics/v8.3.40/* src/ultralytics/
          elif [ "${SRC}" = "PYPI_BEFORE_ATTACK" ]; then
            echo "Using directory: $SELECTED"
            rsync -av --ignore-times vendored/ultralytics-before-attack/* src/ultralytics/
          else
            echo "Unknown SRC: ${SRC}"
            exit 1
          fi

          git add src/ultralytics/
          git commit --allow-empty -m "reset src/ultralytics"
      
          # Figure out which branch to push to:
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            TARGET_BRANCH="${GITHUB_HEAD_REF}"
          else
            TARGET_BRANCH="${GITHUB_REF#refs/heads/}"
          fi
          echo "TARGET_BRANCH=$TARGET_BRANCH"
          git push origin HEAD:"$TARGET_BRANCH"
    
      - name: Set comparison refs
        id: refs
        env:
          DEFAULT_BRANCH: main
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            # Compare main vs PR
            echo "base_ref=${DEFAULT_BRANCH}" >> "$GITHUB_OUTPUT"
            echo "head_ref=${GITHUB_HEAD_REF}" >> "$GITHUB_OUTPUT"
          else
            # Non-PR (e.g. workflow_dispatch on main):
            # Compare HEAD-1 vs HEAD on main
            echo "base_ref=HEAD~1" >> "$GITHUB_OUTPUT"
            echo "head_ref=HEAD"   >> "$GITHUB_OUTPUT"
          fi
      
      - uses: chainguard-dev/malcontent-action@228e2bc9f055a1cd367d59e380c947e76a6e25d4
        id: malcontent
        with:
          github-token: ${{ steps.octo-sts.outputs.token }}
          fail-on-increase: false
          base-ref: ${{ steps.refs.outputs.base_ref }}
          head-ref: ${{ steps.refs.outputs.head_ref }}
    
      - name: Evaluate risk threshold
        run: |
          RISK_DELTA="${{ steps.malcontent.outputs['risk-delta'] }}"
          echo "Risk delta: $RISK_DELTA"
      
          # Convert to number safely
          NUM_DELTA=$(jq -n "$RISK_DELTA" 2>/dev/null || echo 0)
      
          if [ "$NUM_DELTA" -gt 20 ]; then
            echo "::error::Significant security risk increase detected!"
            echo "${{ steps.malcontent.outputs['diff-summary'] }}"
            exit 1
          else
            echo "Risk delta below threshold â€” continuing."
          fi
            
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@ce28f5bb42b7a9f2c824e633a3f6ee835bab6858 #v3.29.0 - 11 Jun 2025
        env:
          GITHUB_TOKEN: ${{ steps.octo-sts.outputs.token }}
        with:
          sarif_file: ${{ steps.malcontent.outputs.sarif-file }}
          category: malcontent
